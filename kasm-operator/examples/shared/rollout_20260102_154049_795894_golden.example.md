---
id: "rollout_20260102_154049_795894_golden"
generated_at: "2026-01-02T16:03:02.835411"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_rbac_security"
difficulty: "medium"
tags: ["security", "rbac", "kubernetes", "serviceaccount", "permissions"]
tech_stack: "Kubernetes RBAC, Go"
---

# User Story
As a security engineer, I want least-privilege RBAC for the VDI operator and users, so the platform follows security best practices.

# Context & Constraints
**Operator ServiceAccount:**
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vdi-operator
  namespace: vdi-operator
```

**ClusterRole (Operator):**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vdi-operator
rules:
  - apiGroups: ["vdi.kasm.io"]
    resources: ["vdisessions", "vdisessions/status"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["vdi.kasm.io"]
    

## Solution
{
  "session_id": "fa9a95ef-8702-4ff4-937b-6d1aeab0353f",
  "response": "I have designed the RBAC manifests to enforce least-privilege security for the Kasm Operator and its users.\n\n**Reasoning:**\n1.  **Operator Identity:** A dedicated `ServiceAccount` (`vdi-operator`) is established to isolate the operator's identity.\n2.  **Operator Privileges (ClusterRole):**\n    *   **VDI Resources:** Full control over `vdisessions` (including status and finalizers) to manage the lifecycle. Read-only access to `vditemplates` as they are config objects.\n    *   **Core Resources:** Management of `pods`, `services`, and `persistentvolumeclaims` is required for the VDI sessions.\n    *   **Secrets (Hardening):** The operator *must* create secrets for dynamic credentials (e.g., `SELKIES_BASIC_AUTH_PASSWORD`). To satisfy the \"No arbitrary secret access\" constraint, I granted `create`, `delete`, `get`, `update`, `patch` but explicitly **denied** `list` and `watch`. This prevents the operator from browsing all secrets in the cluster, limiting it to interacting only with known/owned secrets.\n    *   **Networking:** Full control over Traefik `ingressroutes` to manage dynamic routing.\n3.  **User Privileges (Role):**\n    *   A namespace-scoped `Role` (`vdi-user`) allows users to `create`, `get`, `list`, and `delete` their own `vdisessions`.\n    *   **Exec Prevention:** By omitting the `pods/exec` resource, users are cryptographically barred from executing commands inside the session pods, satisfying the \"No Pod Exec\" constraint.\n4.  **Audit Compliance:** A sample `AuditPolicy` is provided to demonstrate how to log detailed events for `vdi.kasm.io` resources, satisfying the audit requirement.\n\n```json\n[\n  {\n    \"path\": \"manifests/rbac/service_account.yaml\",\n    \"content\": \"apiVersion: v1\\nkind: ServiceAccount\\nmetadata:\\n  name: vdi-operator\\n  namespace: vdi-operator\"\n  },\n  {\n    \"path\": \"manifests/rbac/operator_role.yaml\",\n    \"content\": \"apiVersion: rbac.authorization.k8s.io/v1\\nkind: ClusterRole\\nmetadata:\\n  name: vdi-operator\\nrules:\\n  # VDI Custom Resources\\n  - apiGroups: [\\\"vdi.kasm.io\\\"]\\n    resources: [\\\"vdisessions\\\", \\\"vdisessions/status\\\", \\\"vdisessions/finalizers\\\"]\\n    verbs: [\\\"get\\\", \\\"list\\\", \\\"watch\\\", \\\"create\\\", \\\"update\\\", \\\"patch\\\", \\\"delete\\\"]\\n  - apiGroups: [\\\"vdi.kasm.io\\\"]\\n    resources: [\\\"vditemplates\\\"]\\n    verbs: [\\\"get\\\", \\\"list\\\", \\\"watch\\\"]\\n  \\n  # Core Kubernetes Resources\\n  - apiGroups: [\\\"\\\"]\\n    resources: [\\\"pods\\\", \\\"services\\\", \\\"persistentvolumeclaims\\\"]\\n    verbs: [\\\"get\\\", \\\"list\\\", \\\"watch\\\", \\\"create\\\", \\\"update\\\", \\\"patch\\\", \\\"delete\\\"]\\n  \\n  # Secrets (Restricted: No list/watch to prevent browsing)\\n  - apiGroups: [\\\"\\\"]\\n    resources: [\\\"secrets\\\"]\\n    verbs: [\\\"create\\\", \\\"delete\\\", \\\"get\\\", \\\"update\\\", \\\"patch\\\

## Key Techniques
- JWT token handling
