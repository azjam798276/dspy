---
id: "rollout_20260102_140348_997518_golden"
generated_at: "2026-01-02T16:03:02.821971"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_monitoring_stack"
difficulty: "medium"
tags: ["devops", "prometheus", "grafana", "metrics", "monitoring"]
tech_stack: "Prometheus, Grafana, ServiceMonitor"
---

# User Story
As a DevOps engineer, I want Prometheus metrics and Grafana dashboards for the VDI platform, so I can monitor session health and GPU utilization.

# Context & Constraints
**Operator Metrics:**
```go
var (
    sessionsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "vdi_sessions_total",
            Help: "Total VDI sessions by phase",
        },
        []string{"phase"},
    )
    sessionDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "vdi_session_duration_seconds",
            Buckets: []float64{60, 300, 900, 1800, 3600},
 

## Solution
{
  "session_id": "67ca8301-98c2-43c0-875c-de92c694fb55",
  "response": "I will generate a JSON response containing the reasoning and a code patch to implement the monitoring stack. The reasoning will explain the addition of Prometheus metrics, a ServiceMonitor, alerting rules, and a Grafana dashboard. The code patch will include the new files: `operator/metrics.go`, `charts/vdi-operator/templates/servicemonitor.yaml`, `charts/vdi-operator/templates/prometheus-rule.yaml`, and `charts/vdi-operator/templates/dashboard-configmap.yaml`, formatted as a unified diff.\n\n```json\n{\n  \"reasoning\": \"Implemented the full monitoring stack for the VDI Operator. \\n1.  **Operator Metrics (`operator/metrics.go`):** Added `vdi_sessions_total` (GaugeVec) and `vdi_session_duration_seconds` (HistogramVec) registered with the controller-runtime metrics registry.\\n2.  **ServiceMonitor (`charts/vdi-operator/templates/servicemonitor.yaml`):** Created a ServiceMonitor to allow Prometheus Operator to scrape the `metrics` port every 30s.\\n3.  **Alerting (`charts/vdi-operator/templates/prometheus-rule.yaml`):** Defined alerts for high session failure rates (>10% failures) and GPU saturation (>90% usage).\\n4.  **Dashboard (`charts/vdi-operator/templates/dashboard-configmap.yaml`):** Created a ConfigMap containing a Grafana dashboard JSON with the requested panels: Active Sessions, Sessions by Template, GPU Utilization, and P95 Duration.\",\n  \"code_patch\": \"diff --git a/operator/metrics.go b/operator/metrics.go\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/operator/metrics.go\\n@@ -0,0 +1,24 @@\\n+package main\\n+\\n+import (\\n+\\t\\\"github.com/prometheus/client_golang/prometheus\\\"\\n+\\t\\\"sigs.k8s.io/controller-runtime/pkg/metrics\\\"\\n+)\\n+\\n+var (\\n+\\tsessionsTotal = prometheus.NewGaugeVec(\\n+\\t\\tprometheus.GaugeOpts{\\n+\\t\\t\\tName: \\\"vdi_sessions_total\\\",\\n+\\t\\t\\tHelp: \\\"Total VDI sessions by phase\\\",\\n+\\t\\t},\\n+\\t\\t[]string{\\\"phase\\\"},\\n+\\t)\\n+\\tsessionDuration = prometheus.NewHistogramVec(\\n+\\t\\tprometheus.HistogramOpts{\\n+\\t\\t\\tName:    \\\"vdi_session_duration_seconds\\\",\\n+\\t\\t\\tHelp:    \\\"Time taken for session to become ready\\\",\\n+\\t\\t\\tBuckets: []float64{60, 300, 900, 1800, 3600},\\n+\\t\\t},\\n+\\t\\t[]string{\\\"template\\\"},\\n+\\t)\\n+)\\n+\\n+func init() {\\n+\\tmetrics.Registry.MustRegister(sessionsTotal, sessionDuration)\\n+}\\ndiff --git a/charts/vdi-operator/templates/servicemonitor.yaml b/charts/vdi-operator/templates/servicemonitor.yaml\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/charts/vdi-operator/templates/servicemonitor.yaml\\n@@ -0,0 +1,22 @@\\n+apiVersion: monitoring.coreos.com/v1\\n+kind: ServiceMonitor\\n+metadata:\\n+  name: {{ include \\\"vdi-operator.fullname\\\" . }}\\n+  labels:\\n+    {{- include \\\"vdi-operator.labels\\\" . | nindent 4 }}\\n+spec:\\n+  selector:\\n+    matchLabels:\\n+      {{- include \\\"vd

## Key Techniques
- JWT token handling
