---
id: "rollout_20260102_140824_060799_golden"
generated_at: "2026-01-02T16:03:02.802399"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_monitoring_stack"
difficulty: "medium"
tags: ["devops", "prometheus", "grafana", "metrics", "monitoring"]
tech_stack: "Prometheus, Grafana, ServiceMonitor"
---

# User Story
As a DevOps engineer, I want Prometheus metrics and Grafana dashboards for the VDI platform, so I can monitor session health and GPU utilization.

# Context & Constraints
**Operator Metrics:**
```go
var (
    sessionsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "vdi_sessions_total",
            Help: "Total VDI sessions by phase",
        },
        []string{"phase"},
    )
    sessionDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "vdi_session_duration_seconds",
            Buckets: []float64{60, 300, 900, 1800, 3600},
 

## Solution
{
  "session_id": "aad6cdde-31d9-468b-a9b5-2b86804245ed",
  "response": "I have analyzed the request and the environment. Since I cannot write files directly, I will generate a JSON response containing the reasoning and a Git patch for the required monitoring implementation, including the `metrics.go` file, ServiceMonitor, Grafana dashboard, and Prometheus rules.\n\n```json\n{\n  \"reasoning\": \"The user requires a monitoring stack for the Kasm VDI Operator. Since the project structure (operator/ and manifests/) is currently missing, I will scaffold the necessary files. \\n\\n1.  **Metrics Implementation**: I will create `operator/controllers/metrics.go` to define the `vdi_sessions_total` (GaugeVec) and `vdi_session_duration` (HistogramVec) metrics. I will use `init()` to register them with the global `controller-runtime/pkg/metrics` registry, which is the standard pattern for Kubebuilder operators.\\n\\n2.  **ServiceMonitor**: I will create `manifests/monitoring/service-monitor.yaml` targeting the `vdi-operator` service on the `metrics` port, enabling Prometheus Operator scraping.\\n\\n3.  **Grafana Dashboard**: I will create `manifests/monitoring/dashboard.json` with the requested panels: Active Sessions (Sum), Sessions by Template (Sum by), GPU Utilization (DCGM average), and Session P95 Duration (Histogram Quantile).\\n\\n4.  **Alerting**: I will create `manifests/monitoring/prometheus-rule.yaml` to alert on high session failure rates.\\n\\nThis `code_patch` creates these files from scratch.\",\n  \"code_patch\": \"diff --git a/manifests/monitoring/dashboard.json b/manifests/monitoring/dashboard.json\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/manifests/monitoring/dashboard.json\\n@@ -0,0 +1,50 @@\\n+{\\n+  \\\"title\\\": \\\"Kasm VDI Operator\\\",\\n+  \\\"panels\\\": [\\n+    {\\n+      \\\"title\\\": \\\"Active Sessions\\\",\\n+      \\\"type\\\": \\\"stat\\\",\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"sum(vdi_sessions_total{phase=\\\\\\\"Running\\\\\\\"})\\\" }\\n+      ]\\n+    },\\n+    {\\n+      \\\"title\\\": \\\"Sessions by Template\\\",\\n+      \\\"type\\\": \\\"timeseries\\\",\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"sum by (template) (vdi_sessions_total)\\\" }\\n+      ]\\n+    },\\n+    {\\n+      \\\"title\\\": \\\"GPU Utilization\\\",\\n+      \\\"type\\\": \\\"gauge\\\",\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"avg(DCGM_FI_DEV_GPU_UTIL{pod=~\\\\\\\"vdi-.*\\\\\\\"})\\\" }\\n+      ]\\n+    },\\n+    {\\n+      \\\"title\\\": \\\"Session P95 Duration\\\",\\n+      \\\"type\\\": \\\"timeseries\\\",\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"histogram_quantile(0.95, vdi_session_duration_seconds_bucket)\\\" }\\n+      ]\\n+    }\\n+  ]\\n+}\\ndiff --git a/manifests/monitoring/prometheus-rule.yaml b/manifests/monitoring/prometheus-rule.yaml\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/manifests/monitoring/pr

## Key Techniques
- JWT token handling
