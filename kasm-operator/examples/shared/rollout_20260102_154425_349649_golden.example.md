---
id: "rollout_20260102_154425_349649_golden"
generated_at: "2026-01-02T16:03:02.797900"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_network_policy"
difficulty: "medium"
tags: ["security", "networkpolicy", "kubernetes", "isolation"]
tech_stack: "Kubernetes NetworkPolicy, Calico/Cilium"
---

# User Story
As a security engineer, I want NetworkPolicies isolating VDI sessions, so compromised sessions cannot attack other pods or internal services.

# Context & Constraints
**Session Isolation Policy:**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vdi-session-isolation
  namespace: vdi
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vdi-session
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: traefik-system
      ports:
        - port: 8080
          protocol: TCP
  e

## Solution
{
  "session_id": "0fb0c439-c55f-43d8-870b-9ddac0bb03f7",
  "response": "```json\n{\n  \"reasoning\": \"I have designed the NetworkPolicies to strictly adhere to the Principle of Least Privilege and the User Story constraints.\\n\\n1.  **Session Isolation (`vdi-session-isolation`)**: This policy is critical for multi-tenant security. It isolates VDI session pods in the `vdi` namespace.\\n    *   **Ingress**: Restricted to the `traefik-system` namespace on port 8080. This ensures that only the Ingress Controller (handling user traffic) can connect to the desktop session. Direct pod-to-pod traffic within the namespace is blocked by the default deny rule.\\n    *   **Egress**: \\n        *   **DNS**: Allowed to CoreDNS (`kube-dns`) to ensure internet connectivity works.\\n        *   **Internet**: Allowed (`0.0.0.0/0`) but with strict exclusions for Private IPv4 ranges (RFC1918). This prevents compromised sessions from scanning or attacking internal cluster services or other sessions.\\n\\n2.  **Operator Isolation (`vdi-operator`)**: Located in the `vdi-operator` namespace.\\n    *   **Ingress**: Restricted to the `monitoring` namespace for metrics scraping (port 8080). This reduces the attack surface of the controller.\\n\\n3.  **Default Deny (`default-deny-all`)**: Added to the `vdi` namespace as requested in the Acceptance Criteria. This creates a zero-trust baseline, ensuring that any pod without a specific allow policy effectively has no network access.\",\n  \"code_changes\": [\n    {\n      \"file\": \"manifests/phase-1/network-policies.yaml\",\n      \"content\": \"apiVersion: networking.k8s.io/v1\\nkind: NetworkPolicy\\nmetadata:\\n  name: default-deny-all\\n  namespace: vdi\\nspec:\\n  podSelector: {}\\n  policyTypes:\\n  - Ingress\\n  - Egress\\n---\\napiVersion: networking.k8s.io/v1\\nkind: NetworkPolicy\\nmetadata:\\n  name: vdi-session-isolation\\n  namespace: vdi\\nspec:\\n  podSelector:\\n    matchLabels:\\n      app.kubernetes.io/name: vdi-session\\n  policyTypes:\\n    - Ingress\\n    - Egress\\n  ingress:\\n    - from:\\n        - namespaceSelector:\\n            matchLabels:\\n              name: traefik-system\\n      ports:\\n        - port: 8080\\n          protocol: TCP\\n  egress:\\n    # Allow DNS\\n    - to:\\n        - namespaceSelector: {}\\n          podSelector:\\n            matchLabels:\\n              k8s-app: kube-dns\\n      ports:\\n        - port: 53\\n          protocol: UDP\\n    # Allow internet (for user applications)\\n    - to:\\n        - ipBlock:\\n            cidr: 0.0.0.0/0\\n            except:\\n              - 10.0.0.0/8\\n              - 172.16.0.0/12\\n              - 192.168.0.0/16\\n---\\napiVersion: networking.k8s.io/v1\\nkind: NetworkPolicy\\nmetadata:\\n  name: vdi-operator\\n  namespace: vdi-operator\\nspec:\\n  podSelector:\\n    matchLabels:\\n      app: vdi-operator\\n  ingress:\\n    - from:\\n        - namespaceSelector:\\n            matchLabels:\\n              name: monitoring\\n    

## Key Techniques
- JWT token handling
