---
id: "rollout_20260102_140413_139702_golden"
generated_at: "2026-01-02T16:03:02.823807"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_monitoring_stack"
difficulty: "medium"
tags: ["devops", "prometheus", "grafana", "metrics", "monitoring"]
tech_stack: "Prometheus, Grafana, ServiceMonitor"
---

# User Story
As a DevOps engineer, I want Prometheus metrics and Grafana dashboards for the VDI platform, so I can monitor session health and GPU utilization.

# Context & Constraints
**Operator Metrics:**
```go
var (
    sessionsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "vdi_sessions_total",
            Help: "Total VDI sessions by phase",
        },
        []string{"phase"},
    )
    sessionDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "vdi_session_duration_seconds",
            Buckets: []float64{60, 300, 900, 1800, 3600},
 

## Solution
{
  "session_id": "b36a44dc-f664-4c73-9e42-820008f56967",
  "response": "```json\n{\n  \"reasoning\": \"To implement the monitoring stack for the VDI platform, I will address the requirements across the Operator code and the Helm chart.\\n\\n1.  **Operator Metrics (Go):** The user story requests a `Sessions by Template` dashboard panel, which requires the `vdi_sessions_total` metric to have a `template` label. The provided snippet only had `phase`, so I will extend it to `[]string{\\\"phase\\\", \\\"template\\\"}` to satisfy the requirement. I will also register these metrics with the controller-runtime registry.\\n\\n2.  **ServiceMonitor:** I will create a `ServiceMonitor` resource in the Helm chart to allow the Prometheus Operator to discover and scrape the `vdi-operator` metrics endpoint.\\n\\n3.  **Alerting:** I will define a `PrometheusRule` to alert on high session failure rates, ensuring proactive notification of platform issues.\\n\\n4.  **Dashboard:** I will generate a Grafana dashboard JSON model that visualizes the key metrics: Active Sessions (by phase/template), GPU Utilization (from DCGM), and Session Startup Duration.\",\n  \"code_changes\": {\n    \"operator/controllers/metrics.go\": \"package controllers\\n\\nimport (\\n\\t\\\"github.com/prometheus/client_golang/prometheus\\\"\\n\\t\\\"sigs.k8s.io/controller-runtime/pkg/metrics\\\"\\n)\\n\\nvar (\\n\\tsessionsTotal = prometheus.NewGaugeVec(\\n\\t\\tprometheus.GaugeOpts{\\n\\t\\t\\tName: \\\"vdi_sessions_total\\\",\\n\\t\\t\\tHelp: \\\"Total VDI sessions by phase and template\\\",\\n\\t\\t},\\n\\t\\t[]string{\\\"phase\\\", \\\"template\\\"},\\n\\t)\\n\\n\\tsessionDuration = prometheus.NewHistogramVec(\\n\\t\\tprometheus.HistogramOpts{\\n\\t\\t\\tName:    \\\"vdi_session_duration_seconds\\\",\\n\\t\\t\\tHelp:    \\\"Time taken for session to become ready\\\",\\n\\t\\t\\tBuckets: []float64{60, 300, 900, 1800, 3600},\\n\\t\\t},\\n\\t\\t[]string{\\\"template\\\"},\\n\\t)\\n)\\n\\nfunc init() {\\n\\t// Register custom metrics with the global controller-runtime registry\\n\\tmetrics.Registry.MustRegister(sessionsTotal, sessionDuration)\\n}\\n\",\n    \"charts/vdi-operator/templates/servicemonitor.yaml\": \"apiVersion: monitoring.coreos.com/v1\\nkind: ServiceMonitor\\nmetadata:\\n  name: {{ include \\\"vdi-operator.fullname\\\" . }}\\n  labels:\\n    {{- include \\\"vdi-operator.labels\\\" . | nindent 4 }}\\nspec:\\n  selector:\\n    matchLabels:\\n      {{- include \\\"vdi-operator.selectorLabels\\\" . | nindent 6 }}\\n  endpoints:\\n  - port: metrics\\n    interval: 30s\\n    path: /metrics\\n\",\n    \"charts/vdi-operator/templates/prometheusrule.yaml\": \"apiVersion: monitoring.coreos.com/v1\\nkind: PrometheusRule\\nmetadata:\\n  name: {{ include \\\"vdi-operator.fullname\\\" . }}-alerts\\n  labels:\\n    {{- include \\\"vdi-operator.labels\\\" . | nindent 4 }}\\nspec:\\n  groups:\\n  - name: vdi-operator.rules\\n    rules:\\n    - alert: VDISessionHighFailureRate\\n      annotations

## Key Techniques
- JWT token handling
