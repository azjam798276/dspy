---
id: "rollout_20260102_133227_078159_golden"
generated_at: "2026-01-02T16:03:02.834375"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_vdisession_crd"
difficulty: "medium"
tags: ["kubernetes", "crd", "openapi", "kubebuilder", "validation"]
tech_stack: "Go 1.21, kubebuilder, OpenAPI v3"
---

# User Story
As a platform engineer, I want a VDISession Custom Resource Definition with proper validation and printer columns, so users can create desktop sessions using kubectl.

# Context & Constraints
**CRD Specification:**
```yaml
apiVersion: vdi.kasm.io/v1alpha1
kind: VDISession
metadata:
  name: alice-desktop
spec:
  user: alice@example.com
  template: ubuntu-desktop
  resources:
    gpu: 1
    memory: "4Gi"
  timeout: "8h"
status:
  phase: Running
  url: https://alice.vdi.example.com
```

**Required Fields:**
| Field | Type | Validation |
|-------|------|------------|
| spec.user | string | Required, email pat

## Solution
{
  "session_id": "b64734f3-bea1-4629-baa2-a75a4312995a",
  "response": "Based on the User Story `20260102_vdisession_crd` and the context provided in `docs/TDD.md`, I need to implement the `VDISession` Custom Resource Definition (CRD) in Go.\n\n**Reasoning:**\n1.  **Project Structure**: The `operator` directory is currently empty/uninitialized. To fulfill the request, I must provide the essential Go files to define the API: `groupversion_info.go` (for schema registration) and `vdisession_types.go` (for the CRD logic).\n2.  **API Group & Version**: Following `TDD.md`, the group is `vdi.kasm.io` and the version is `v1alpha1`.\n3.  **VDISessionSpec**:\n    *   **User**: Defined as a required string with a regex pattern (`^\\S+@\\S+\\.\\S+$`) to enforce the \"email pattern\" requirement.\n    *   **Template**: Required string reference.\n    *   **Resources**: A nested struct `ResourceSpec` containing `Gpu` (int) and `Memory` (string). I added `+kubebuilder:default` and `+kubebuilder:validation:Minimum` markers as requested.\n    *   **Timeout**: String with a default of \"8h\".\n4.  **VDISessionStatus**: Includes `Phase` (Enum), `PodName`, `Url`, `StartTime`, and `Message` to track session state, matching the User Story's status fields.\n5.  **Kubebuilder Markers**:\n    *   `+kubebuilder:object:root=true` for the main type and list.\n    *   `+kubebuilder:subresource:status` to enable the status subresource.\n    *   `+kubebuilder:printcolumn` to expose User, Phase, and URL in `kubectl get`.\n    *   `+kubebuilder:resource:shortName=vdi` for convenience.\n\n```json\n{\n  \"reasoning\": \"I have designed the `VDISession` API definition to meet the User Story requirements. I am creating two files in the `operator/api/v1alpha1` directory: `groupversion_info.go` to establish the API group `vdi.kasm.io`, and `vdisession_types.go` to define the CRD structs. The `VDISessionSpec` includes strict validation for the `User` email field and defaults for `Resources` and `Timeout`. The `VDISessionStatus` utilizes an Enum for the `Phase` to ensure state consistency. Printer columns and the shortname `vdi` are configured via Kubebuilder markers.\",\n  \"code_changes\": {\n    \"operator/api/v1alpha1/groupversion_info.go\": \"/*\\nCopyright 2026 The Kasm Operator Authors.\\n*/\\n\\n// Package v1alpha1 contains API Schema definitions for the vdi v1alpha1 API group\\n// +kubebuilder:object:generate=true\\n// +groupName=vdi.kasm.io\\npackage v1alpha1\\n\\nimport (\\n\\t\\\"k8s.io/apimachinery/pkg/runtime/schema\\\"\\n\\t\\\"sigs.k8s.io/controller-runtime/pkg/scheme\\\"\\n)\\n\\nvar (\\n\\t// GroupVersion is group version used to register these objects\\n\\tGroupVersion = schema.GroupVersion{Group: \\\"vdi.kasm.io\\\", Version: \\\"v1alpha1\\\"}\\n\\n\\t// SchemeBuilder is used to add go types to the GroupVersionKind scheme\\n\\tSchemeBuilder = &scheme.Builder{GroupVersion: GroupVersion}\\n\\n\\t// AddToScheme adds the types in this group-version to the given scheme.\

## Key Techniques
- JWT token handling
- Input validation
