---
id: "rollout_20260102_140211_580508_golden"
generated_at: "2026-01-02T16:03:02.840471"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_monitoring_stack"
difficulty: "medium"
tags: ["devops", "prometheus", "grafana", "metrics", "monitoring"]
tech_stack: "Prometheus, Grafana, ServiceMonitor"
---

# User Story
As a DevOps engineer, I want Prometheus metrics and Grafana dashboards for the VDI platform, so I can monitor session health and GPU utilization.

# Context & Constraints
**Operator Metrics:**
```go
var (
    sessionsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "vdi_sessions_total",
            Help: "Total VDI sessions by phase",
        },
        []string{"phase"},
    )
    sessionDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "vdi_session_duration_seconds",
            Buckets: []float64{60, 300, 900, 1800, 3600},
 

## Solution
{
  "session_id": "ff818817-250c-4bd8-8f5c-7252998c8d1e",
  "response": "```json\n{\n  \"reasoning\": \"I have implemented the monitoring stack components as requested. \\n\\n1.  **Metrics Definition (`operator/controllers/metrics.go`)**: I created a new Go file to define the `vdi_sessions_total` and `vdi_session_duration_seconds` metrics and registered them with the controller-runtime metrics registry. This aligns with the provided context and enables the operator to export these metrics.\\n2.  **ServiceMonitor (`charts/vdi-operator/templates/servicemonitor.yaml`)**: I created a ServiceMonitor resource to configure the Prometheus Operator to scrape metrics from the VDI operator's service on port `metrics`. This ensures the metrics are ingested into Prometheus.\\n3.  **Alerting Rules (`charts/vdi-operator/templates/prometheusrule.yaml`)**: I defined a PrometheusRule to alert on high session failure rates (`VDISessionHighFailureRate`), providing proactive monitoring for platform health.\\n4.  **Grafana Dashboard (`charts/vdi-operator/dashboards/vdi-dashboard.json`)**: I constructed a Grafana dashboard JSON containing the four key panels requested: Active Sessions, Sessions by Template, GPU Utilization (using DCGM metrics), and Session P95 Duration. This provides the required visualization.\\n\\nNote: As the `operator/` directory was empty, I've provided the `metrics.go` file which would need to be integrated into the operator's package structure.\",\n  \"code_patch\": \"diff --git a/charts/vdi-operator/dashboards/vdi-dashboard.json b/charts/vdi-operator/dashboards/vdi-dashboard.json\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/charts/vdi-operator/dashboards/vdi-dashboard.json\\n@@ -0,0 +1,98 @@\\n+{\\n+  \\\"annotations\\\": {\\n+    \\\"list\\\": []\\n+  },\\n+  \\\"editable\\\": true,\\n+  \\\"gnetId\\\": null,\\n+  \\\"graphTooltip\\\": 0,\\n+  \\\"id\\\": null,\\n+  \\\"links\\\": [],\\n+  \\\"panels\\\": [\\n+    {\\n+      \\\"title\\\": \\\"Active Sessions\\\",\\n+      \\\"type\\\": \\\"stat\\\",\\n+      \\\"gridPos\\\": { \\\"h\\\": 4, \\\"w\\\": 6, \\\"x\\\": 0, \\\"y\\\": 0 },\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"sum(vdi_sessions_total{phase=\\\\\\\"Running\\\\\\\"})\\\", \\\"legendFormat\\\": \\\"Running Sessions\\\" }\\n+      ]\\n+    },\\n+    {\\n+      \\\"title\\\": \\\"Sessions by Template\\\",\\n+      \\\"type\\\": \\\"barchart\\\",\\n+      \\\"gridPos\\\": { \\\"h\\\": 8, \\\"w\\\": 12, \\\"x\\\": 6, \\\"y\\\": 0 },\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"sum by (template) (vdi_sessions_total)\\\", \\\"legendFormat\\\": \\\"{{template}}\\\" }\\n+      ]\\n+    },\\n+    {\\n+      \\\"title\\\": \\\"GPU Utilization\\\",\\n+      \\\"type\\\": \\\"timeseries\\\",\\n+      \\\"gridPos\\\": { \\\"h\\\": 8, \\\"w\\\": 12, \\\"x\\\": 0, \\\"y\\\": 4 },\\n+      \\\"targets\\\": [\\n+        { \\\"expr\\\": \\\"avg(DCGM_FI_DEV_GPU_UTIL{pod=~\\\\\\\"vdi-.*\\\\\\\"

## Key Techniques
- JWT token handling
- Input validation
