---
id: "rollout_20260102_154225_318588_golden"
generated_at: "2026-01-02T16:03:02.813210"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_network_policy"
difficulty: "medium"
tags: ["security", "networkpolicy", "kubernetes", "isolation"]
tech_stack: "Kubernetes NetworkPolicy, Calico/Cilium"
---

# User Story
As a security engineer, I want NetworkPolicies isolating VDI sessions, so compromised sessions cannot attack other pods or internal services.

# Context & Constraints
**Session Isolation Policy:**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vdi-session-isolation
  namespace: vdi
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vdi-session
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: traefik-system
      ports:
        - port: 8080
          protocol: TCP
  e

## Solution
{
  "session_id": "a1574b0c-775c-4e98-87ca-020a6717ef77",
  "response": "```json\n{\n  \"reasoning\": \"I have designed the NetworkPolicies to meet the security isolation requirements for the VDI platform. \\n\\n1.  **Session Isolation (`vdi-session-isolation.yaml`)**: \\n    -   **Ingress**: Restricted to the `traefik-system` namespace on port 8080, ensuring only the Ingress controller can reach the VDI sessions.\\n    -   **Egress**: Blocked access to private IP ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) to prevent lateral movement to other internal services. Allowed 0.0.0.0/0 (Internet) and DNS (UDP 53).\\n\\n2.  **Operator Isolation (`vdi-operator-isolation.yaml`)**: \\n    -   **Ingress**: Restricted to the `monitoring` namespace on port 8080 for metrics scraping. All other ingress is implicitly denied by the default behavior when a policy selects the pod, or by the default deny if applied.\\n\\n3.  **Default Deny (`default-deny.yaml`)**: \\n    -   Added a catch-all `default-deny-all` policy for the `vdi` namespace to satisfy the 'Default Deny' acceptance criteria. This ensures any pod without a specific allow policy is isolated.\\n\\n4.  **Verification (`test-policies.sh`)**: \\n    -   Created a shell script to automate the verification of these policies using temporary curl pods, covering ingress blocking and basic connectivity checks.\\n\\n5.  **Structure**: Placed all files in `manifests/security/` for clarity.\",\n  \"code_patch\": \"diff --git a/manifests/security/README.md b/manifests/security/README.md\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/manifests/security/README.md\\n@@ -0,0 +1,24 @@\\n+# VDI Security Policies\\n+\\n+This directory contains NetworkPolicies for isolating VDI sessions and the Operator.\\n+\\n+## Policies\\n+\\n+- **vdi-session-isolation.yaml**: \\n+  - Allows Ingress from Traefik (must label traefik namespace: `kubectl label ns traefik-system name=traefik-system`)\\n+  - Allows Egress to Internet and DNS\\n+  - Blocks Egress to Private Networks (10.x, 172.16.x, 192.168.x)\\n+\\n+- **vdi-operator-isolation.yaml**:\\n+  - Allows Ingress from Monitoring (must label monitoring namespace: `kubectl label ns monitoring name=monitoring`)\\n+\\n+- **default-deny.yaml**:\\n+  - Denies all Ingress/Egress in `vdi` namespace by default.\\n+\\n+## Usage\\n+\\n+```bash\\n+kubectl apply -f manifests/security/\\n+```\\n+\\n+## Testing\\n+\\n+Run `./test-policies.sh` to verify isolation rules.\\n\\\\ No newline at end of file\\ndiff --git a/manifests/security/default-deny.yaml b/manifests/security/default-deny.yaml\\nnew file mode 100644\\nindex 0000000..e69de29\\n--- /dev/null\\n+++ b/manifests/security/default-deny.yaml\\n@@ -0,0 +1,11 @@\\n+apiVersion: networking.k8s.io/v1\\n+kind: NetworkPolicy\\n+metadata:\\n+  name: default-deny-all\\n+  namespace: vdi\\n+spec:\\n+  podSelector: {}\\n+  policyTypes:\\n+  - Ingress\\n+  - Egress\\n+\\ndiff --git a/manifests/security/test-policies.sh b/

## Key Techniques
- JWT token handling
