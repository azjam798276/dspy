---
id: "rollout_20260102_140744_550210_golden"
generated_at: "2026-01-02T16:03:02.819755"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_monitoring_stack"
difficulty: "medium"
tags: ["devops", "prometheus", "grafana", "metrics", "monitoring"]
tech_stack: "Prometheus, Grafana, ServiceMonitor"
---

# User Story
As a DevOps engineer, I want Prometheus metrics and Grafana dashboards for the VDI platform, so I can monitor session health and GPU utilization.

# Context & Constraints
**Operator Metrics:**
```go
var (
    sessionsTotal = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "vdi_sessions_total",
            Help: "Total VDI sessions by phase",
        },
        []string{"phase"},
    )
    sessionDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "vdi_session_duration_seconds",
            Buckets: []float64{60, 300, 900, 1800, 3600},
 

## Solution
{
  "session_id": "5b2c6e58-1595-4102-84d6-3f1c71bb149b",
  "response": "```json\n{\n  \"reasoning\": \"I have implemented the monitoring stack for the VDI Operator based on the requirements.\\n\\n1.  **Operator Metrics (`operator/metrics.go`)**: I added a Go file to define and register the Prometheus metrics (`vdi_sessions_total` and `vdi_session_duration`) as specified in the User Story and TDD. This integrates with `controller-runtime`'s metrics registry.\\n2.  **ServiceMonitor (`manifests/monitoring/service-monitor.yaml`)**: I created a ServiceMonitor resource to instruct the Prometheus Operator to scrape the `vdi-operator` service on the `metrics` port every 30 seconds.\\n3.  **Alerting (`manifests/monitoring/prometheus-rule.yaml`)**: I added a PrometheusRule to trigger an alert (`VDISessionFailures`) if the rate of failed sessions exceeds zero, ensuring proactive incident response.\\n4.  **Dashboard (`manifests/monitoring/dashboard.json`)**: I generated a Grafana dashboard JSON (simplified) containing the four key panels requested: Active Sessions, Sessions by Template, GPU Utilization (via DCGM), and Session P95 Duration.\\n\\nThis setup provides full observability into the VDI platform's health and performance.\",\n  \"code_patch\": \"diff --git a/operator/metrics.go b/operator/metrics.go\\nnew file mode 100644\\nindex 0000000..b8f9a2e\\n--- /dev/null\\n+++ b/operator/metrics.go\\n@@ -0,0 +1,27 @@\\n+package main\\n+\\n+import (\\n+\\t\\\"github.com/prometheus/client_golang/prometheus\\\"\\n+\\t\\\"sigs.k8s.io/controller-runtime/pkg/metrics\\\"\\n+)\\n+\\n+var (\\n+\\tsessionsTotal = prometheus.NewGaugeVec(\\n+\\t\\tprometheus.GaugeOpts{\\n+\\t\\t\\tName: \\\"vdi_sessions_total\\\",\\n+\\t\\t\\tHelp: \\\"Total VDI sessions by phase\\\",\\n+\\t\\t},\\n+\\t\\t[]string{\\\"phase\\\"},\\n+\\t)\\n+\\n+\\tsessionDuration = prometheus.NewHistogramVec(\\n+\\t\\tprometheus.HistogramOpts{\\n+\\t\\t\\tName:    \\\"vdi_session_duration_seconds\\\",\\n+\\t\\t\\tBuckets: []float64{60, 300, 900, 1800, 3600},\\n+\\t\\t},\\n+\\t\\t[]string{\\\"template\\\"},\\n+\\t)\\n+)\\n+\\n+func init() {\\n+\\tmetrics.Registry.MustRegister(sessionsTotal, sessionDuration)\\n+}\\ndiff --git a/manifests/monitoring/service-monitor.yaml b/manifests/monitoring/service-monitor.yaml\\nnew file mode 100644\\nindex 0000000..c4d5e6f\\n--- /dev/null\\n+++ b/manifests/monitoring/service-monitor.yaml\\n@@ -0,0 +1,13 @@\\n+apiVersion: monitoring.coreos.com/v1\\n+kind: ServiceMonitor\\n+metadata:\\n+  name: vdi-operator\\n+  labels:\\n+    release: prometheus\\n+spec:\\n+  selector:\\n+    matchLabels:\\n+      app: vdi-operator\\n+  endpoints:\\n+  - port: metrics\\n+    interval: 30s\\ndiff --git a/manifests/monitoring/prometheus-rule.yaml b/manifests/monitoring/prometheus-rule.yaml\\nnew file mode 100644\\nindex 0000000..d5e6f7g\\n--- /dev/null\\n+++ b/manifests/monitoring/prometheus-rule.yaml\\n@@ -0,0 +1,24 @@\\n+apiVersion: monitoring.coreos.com/v1\\n+kind: PrometheusRule\\n+me

## Key Techniques
- JWT token handling
