---
id: "rollout_20260102_134408_822087_golden"
generated_at: "2026-01-02T16:03:02.807811"
tags: ["shared", "auto-generated"]
---

## Problem
---
id: "20260102_vdisession_crd"
difficulty: "medium"
tags: ["kubernetes", "crd", "openapi", "kubebuilder", "validation"]
tech_stack: "Go 1.21, kubebuilder, OpenAPI v3"
---

# User Story
As a platform engineer, I want a VDISession Custom Resource Definition with proper validation and printer columns, so users can create desktop sessions using kubectl.

# Context & Constraints
**CRD Specification:**
```yaml
apiVersion: vdi.kasm.io/v1alpha1
kind: VDISession
metadata:
  name: alice-desktop
spec:
  user: alice@example.com
  template: ubuntu-desktop
  resources:
    gpu: 1
    memory: "4Gi"
  timeout: "8h"
status:
  phase: Running
  url: https://alice.vdi.example.com
```

**Required Fields:**
| Field | Type | Validation |
|-------|------|------------|
| spec.user | string | Required, email pat

## Solution
{
  "session_id": "279d4cbb-bc8d-47d7-b6f1-96d2449b0612",
  "response": "Based on the User Story and TDD, I need to define the `VDISession` Custom Resource Definition (CRD) in Go using Kubebuilder markers.\n\n**Reasoning:**\n1.  **Structure**: I will place the code in `operator/api/v1alpha1/vdisession_types.go`, following the project structure defined in `GEMINI.md` where `operator/` contains the Go code.\n2.  **Fields Mapping**:\n    -   `Spec.User`: Mapped to `User string`, marked Required, and I'll add a regex pattern for basic email validation (`^\\\\S+@\\\\S+\\\\.\\\\S+$`).\n    -   `Spec.Template`: Mapped to `Template string`, marked Required.\n    -   `Spec.Resources`: Mapped to a nested struct `ResourceSpec`.\n    -   `Resources.GPU`: Mapped to `int`, Default: 1, Minimum: 1.\n    -   `Resources.Memory`: Mapped to `string`, Default: \"4Gi\".\n    -   `Spec.Timeout`: Mapped to `string`, Default: \"8h\".\n3.  **Status**:\n    -   `Phase`: Mapped to `string` with Enum validation (Pending, Creating, Running, Terminating, Failed).\n    -   `URL`, `PodName`, `Message`: Standard strings.\n    -   `StartTime`: `metav1.Time`.\n4.  **Kubebuilder Markers**:\n    -   `+kubebuilder:object:root=true` and `+kubebuilder:subresource:status` for the main type.\n    -   `+kubebuilder:printcolumn` to satisfy the `kubectl get` visibility requirements.\n    -   `+kubebuilder:resource:shortName=vdi` as requested.\n\n```json\n{\n  \"reasoning\": \"I am creating the VDISession CRD Go definitions in `operator/api/v1alpha1/vdisession_types.go`. This file defines the `VDISessionSpec` and `VDISessionStatus` structs with strict Kubebuilder validation markers (enums, defaults, patterns) to meet the User Story requirements. I have also included the necessary `//+kubebuilder:printcolumn` markers to expose User, Phase, and URL fields in `kubectl get` output, and registered the `vdi` shortname.\",\n  \"code_changes\": {\n    \"operator/api/v1alpha1/vdisession_types.go\": \"package v1alpha1\\n\\nimport (\\n\\tmetav1 \\\"k8s.io/apimachinery/pkg/apis/meta/v1\\\"\\n)\\n\\n// VDISessionSpec defines the desired state of VDISession\\ntype VDISessionSpec struct {\\n\\t// User is the email or ID of the user requesting the session\\n\\t// +kubebuilder:validation:Required\\n\\t// +kubebuilder:validation:Pattern=`^\\\\S+@\\\\S+\\\\.\\\\S+$`\\n\\tUser string `json:\\\"user\\\"`\\n\\n\\t// Template is the name of the VDITemplate to use\\n\\t// +kubebuilder:validation:Required\\n\\tTemplate string `json:\\\"template\\\"`\\n\\n\\t// Resources configures the compute resources for the session\\n\\t// +kubebuilder:default={gpu:1, memory:\\\"4Gi\\\"}\\n\\tResources ResourceSpec `json:\\\"resources,omitempty\\\"`\\n\\n\\t// Timeout defines how long the session can run (e.g., \\\"8h\\\")\\n\\t// +kubebuilder:default=\\\"8h\\\"\\n\\tTimeout string `json:\\\"timeout,omitempty\\\"`\\n}\\n\\n// ResourceSpec defines the compute resources\\ntype ResourceSpec struct {\\n\\t// GPU count for the session\

## Key Techniques
- JWT token handling
- Input validation
