---
id: "rollout_20251226_102234_280063_golden"
generated_at: "2026-01-02T16:24:01.914135"
tags: ["k8s-operator", "auto-generated"]
---

## Problem
---
id: "20251225_api_sec_bola"
source_url: "https://github.com/VArtzy/NodeJS-OWASP-API-Security"
difficulty: "medium"
tags: ["security", "authorization", "node.js", "express", "jwt"]
tech_stack: "Node.js, Express.js, JWT, Jest"
---

# User Story
As a shop owner, I should only see my own revenue data when accessing the `/shops/:shopName/revenue` endpoint, so that business-critical information remains confidential.

# Context & Constraints
The API currently allows any authenticated user to access revenue data for ANY shop by simply knowing the shop name. This is a **Broken Object Level Authorization (BOLA)** vulnerability - one of the OWASP Top 10 API Security Risks.

**Current Vulnerable Pattern:**
```javascript
app.get('/shops/:shopName/revenue', (req, res) => {
    const shopName = req.p

## Solution
{
  "session_id": "a79e4c08-4c17-4ee4-82cc-3c871036c0fc",
  "response": "```json\n{\n  \"reasoning\": \"## Implementation Plan\\n\\n1.  **Analyze Complexity**: The solution uses O(1) hash map lookups for retrieving shop data, ensuring high performance. Token verification is stateless and efficient (O(1)).\\n2.  **Security Architecture**:\\n    *   **Authentication**: `verifyToken` middleware enforces identity verification using JWT.\\n    *   **Authorization (BOLA Prevention)**: `checkShopOwnership` middleware explicitly validates that the authenticated `userId` matches the `shop.ownerId`. This directly addresses the BOLA vulnerability.\\n    *   **Zero Trust**: All requests are treated as untrusted until validated.\\n3.  **Edge Cases**: The code handles missing tokens (401), invalid tokens (403), non-existent shops (404), and unauthorized access attempts (403).\\n4.  **Testing**: Comprehensive tests cover the happy path (authorized access), the attack vector (unauthorized access to another's shop), and error states (404, 401).\",\n  \"code\": {\n    \"package.json\": \"{\\n  \\\"name\\\": \\\"bola-prevention\\\",\\n  \\\"version\\\": \\\"1.0.0\\\",\\n  \\\"main\\\": \\\"src/app.js\\\",\\n  \\\"scripts\\\": {\\n    \\\"test\\\": \\\"jest\\\"\\n  },\\n  \\\"dependencies\\\": {\\n    \\\"express\\\": \\\"^4.18.2\\\",\\n    \\\"jsonwebtoken\\\": \\\"^9.0.0\\\"\\n  },\\n  \\\"devDependencies\\\": {\\n    \\\"jest\\\": \\\"^29.0.0\\\",\\n    \\\"supertest\\\": \\\"^6.0.0\\\"\\n  }\\n}\",\n    \"src/app.js\": \"const express = require('express');\\nconst jwt = require('jsonwebtoken');\\n\\nconst app = express();\\napp.use(express.json());\\n\\nconst JWT_SECRET = process.env.JWT_SECRET || 'test-secret';\\n\\n// Mock Database\\nconst revenueData = {\\n    'shopA': { ownerId: 'user1', revenue: { monthly: 5000 } },\\n    'shopB': { ownerId: 'user2', revenue: { monthly: 7500 } }\\n};\\n\\n/**\\n * Middleware to verify JWT and extract userId\\n * Complexity: O(1) - Stateless verification\\n */\\nconst verifyToken = (req, res, next) => {\\n    const authHeader = req.headers.authorization;\\n    if (!authHeader) {\\n        return res.status(401).json({ error: 'Access token required' });\\n    }\\n\\n    const token = authHeader.split(' ')[1];\\n    if (!token) {\\n        return res.status(401).json({ error: 'Access token required' });\\n    }\\n\\n    try {\\n        const decoded = jwt.verify(token, JWT_SECRET);\\n        req.userId = decoded.userId;\\n        next();\\n    } catch (err) {\\n        return res.status(403).json({ error: 'Invalid or expired token' });\\n    }\\n};\\n\\n/**\\n * Middleware to check if authenticated user owns the shop\\n * Prevents BOLA by strictly enforcing resource ownership.\\n * Complexity: O(1) - Key lookup\\n */\\nconst checkShopOwnership = (req, res, next) => {\\n    const { shopName } = req.params;\\n    const shop = revenueData[shopName];\\n\\n    // Handle 404 - Shop not found\\n    if (!shop) {\\n        return res.s

## Key Techniques
- async/await
- try/catch error handling
- JWT token handling
- Input validation
- Middleware pattern
